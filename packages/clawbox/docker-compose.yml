version: "3.9"

# ClawBox — Hardened Docker deployment for OpenClaw
# ClawSentinel v0.1.0
#
# Architecture:
#   - openclaw runs on internal network only (no exposed ports)
#   - All client traffic goes through clawguard (:18790)
#   - traefik handles TLS termination and rate limiting (external access)
#   - fail2ban monitors host logs for brute force

services:

  openclaw:
    image: openclaw/openclaw:latest
    restart: unless-stopped
    read_only: true                          # Container filesystem is read-only
    tmpfs:
      - /tmp:size=256m,mode=1777            # Agent gets writable /tmp only
    volumes:
      - ${HOME}/.openclaw:/home/user/.openclaw:ro    # Config mounted read-only
      - ${HOME}/Documents:/home/user/Documents:ro    # User files read-only by default
      - clawsentinel-data:/var/clawsentinel          # ClawSentinel's own data (rw)
    environment:
      - OPENCLAW_GATEWAY_PORT=18789
      - OPENCLAW_CANVAS_CSP=true             # Enforce CSP on canvas endpoint (blocks XSS)
      - OPENCLAW_DM_POLICY=paired            # No open DMs — paired devices only (CVE T3)
      - OPENCLAW_SHELL_ALLOWLIST=echo,ls,cat,pwd,date
      - OPENCLAW_SHELL_DENYLIST=curl,wget,nc,ncat,python,ruby,perl,bash,sh
    networks:
      - internal                             # Internal network only — NOT exposed to host
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '2.0'

  clawguard:
    build:
      context: ../clawguard
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:18790:18790"             # Localhost only — not LAN-accessible
      - "127.0.0.1:18791:18791"             # Local API bridge for Chrome extension
    environment:
      - UPSTREAM_WS=ws://openclaw:18789
      - UPSTREAM_HTTP=http://openclaw:18789
      - DB_PATH=/var/clawsentinel/audit.db
      - LOG_LEVEL=info
    volumes:
      - clawsentinel-data:/var/clawsentinel
    networks:
      - internal
    depends_on:
      - openclaw
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18791/health', r => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 5s
      retries: 3

  claweye:
    build:
      context: ../claweye
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:7432:7432"              # Dashboard — localhost only
    environment:
      - DB_PATH=/var/clawsentinel/clawsentinel.db
      - PORT=7432
      - NODE_ENV=production
    volumes:
      - clawsentinel-data:/var/clawsentinel:ro
    networks:
      - internal
    depends_on:
      - clawguard

  traefik:
    image: traefik:v3.0
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.network=internal"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.le.acme.tlschallenge=true"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
      - "--api.dashboard=false"             # Security: disable Traefik dashboard
      - "--accesslog=true"
      - "--log.level=WARN"
    ports:
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - traefik-certs:/letsencrypt
    labels:
      # Global rate limiting middleware
      - "traefik.http.middlewares.ratelimit.ratelimit.average=10"
      - "traefik.http.middlewares.ratelimit.ratelimit.burst=20"
      - "traefik.http.middlewares.ratelimit.ratelimit.period=1s"
      # Security headers middleware
      - "traefik.http.middlewares.secheaders.headers.framedeny=true"
      - "traefik.http.middlewares.secheaders.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.secheaders.headers.browserxssfilter=true"
      - "traefik.http.middlewares.secheaders.headers.referrerpolicy=no-referrer"
    networks:
      - internal

  fail2ban:
    image: crazymax/fail2ban:latest
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./fail2ban/jail.conf:/etc/fail2ban/jail.conf:ro
      - ./fail2ban/filter.d:/etc/fail2ban/filter.d:ro
      - /var/log:/var/log:ro
      - fail2ban-data:/var/lib/fail2ban

volumes:
  clawsentinel-data:
    name: clawsentinel-data
  traefik-certs:
    name: traefik-certs
  fail2ban-data:
    name: fail2ban-data

networks:
  internal:
    driver: bridge
    internal: true                           # No direct internet access from containers
    ipam:
      config:
        - subnet: 172.20.0.0/24
